{% extends "base.html" %}
{% load static %}
{% block title %}Мой блог | Отправить сообщение{% endblock %}
{% block content %}
    <link rel="stylesheet"
          type="text/css"
          href="{% static 'css/send-message.css' %}">
    <div style="margin-top: 1%">
        <div class="container-fluid">
            <div class="row align-items-start">
                <div class="col">
                    <div class="card shadow-1-strong">
                        <div class="card-body">
                            <h2>Отправить сообщение</h2>
                            <form method="post">
                                {% csrf_token %}
                                <div class="form-group">
                                    <label for="recipient">Получатель:</label>
                                    <input type="text"
                                           id="recipient"
                                           name="recipient"
                                           class="form-control"
                                           placeholder="Введите имя пользователя">
                                    <div id="recipient-suggestions"></div>
                                </div>
                                <div class="form-group">
                                    <label for="subject">Тема:</label>
                                    <input type="text" name="subject" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="body">Сообщение:</label>
                                    <textarea name="body" class="form-control"></textarea>
                                </div>
                                <div class="mt-3"></div>
                                <button type="submit" class="btn btn-primary">Отправить</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            var recipient = getUrlParameter('recipient');
            $('#recipient').val(recipient);
        });
        
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }
        
        $(document).ready(function() {
            var suggestions = [];
        
            $('#recipient').on('input', function() {
                var input = $(this).val();
                if (input.length > 0) {
                    $.ajax({
                        url: '/get_user_suggestions/',
                        type: 'GET',
                        data: { 'input_text': input },
                        success: function(response) {
                            suggestions = response;
                            displaySuggestions(response);
                        },
                        error: function(xhr, errmsg, err) {
                            console.log(xhr.status + ": " + xhr.responseText);
                        }
                    });
                } else {
                    $('#recipient-suggestions').hide();
                }
            });
        
            $('#recipient').focus(function() {
                var input = $(this).val();
                if (input.length > 0) {
                    $('#recipient-suggestions').show();
                }
            });
        
            $('#recipient').blur(function() {
                $('#recipient-suggestions').hide();
            });
        
            $(document).on('click', '#recipient-suggestions li', function() {
                var selectedName = $(this).text();
                $('#recipient').val(selectedName);
                $('#recipient-suggestions').hide();
            });
        
            $('form').submit(function(event) {
                var enteredName = $('#recipient').val();
                if (suggestions.indexOf(enteredName) === -1) {
                    event.preventDefault();
                    alert('Введите существующее имя из списка подсказок.');
                }
            });
        
            function displaySuggestions(suggestions) {
                $('#recipient-suggestions').empty();
                if (suggestions.length > 0) {
                    var list = $('<ul></ul>');
                    $.each(suggestions, function(index, suggestion) {
                        list.append($('<li></li>').text(suggestion));
                    });
                    $('#recipient-suggestions').append(list);
                    $('#recipient-suggestions').show();
                } else {
                    $('#recipient-suggestions').hide();
                }
            }
        });                
    </script>
{% endblock %}
